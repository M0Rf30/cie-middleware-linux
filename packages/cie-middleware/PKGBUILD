targets=(
    "archlinux"
    "fedora"
    "opensuse"
    "ubuntu"
)
pkgname="cie-middleware"
pkgver="1.4.1"
pkgrel="1"
pkgdesc="Middleware della CIE (Carta di Identità Elettronica) per Linux"
pkgdesclong=("Middleware della CIE (Carta di Identità Elettronica) per Linux")
maintainer="boiano.gianluca@gmail.com"
url="https://github.com/italia/cie-middleware-linux"
arch="amd64"
license=("BSD-3")
section="utils"
priority="optional"
sources=(
    "https://github.com/M0Rf30/cie-middleware-linux/archive/main.tar.gz"
    "https://downloads.gradle-dn.com/distributions/gradle-7.3-bin.zip"
)
sources:archlinux=("https://github.com/M0Rf30/cie-middleware-linux/archive/main.tar.gz")

hashsums=(
    "skip"
    "skip"
)
hashsums:archlinux=(
    "skip"
)
depends:apt=(
    "cryptopp"
    "libpcsclite1"
    "libssl1.1"
    "openjdk-11-jre-headless"
    "pcscd"
)
makedepends:apt=(
    "g++"  
    "libpcsclite-dev"
    "openjdk-11-jre-headless"
    "libssl-dev"
    "pkg-config"
    "python3-pip"
    "unzip"
)

depends:pacman=(
    "java-runtime"
    "crypto++"
    "openssl"
    "pcsclite"
)
makedepends:pacman=(
    "crypto++"
    "gradle"
    "meson"
    "pcsclite"
    "pkgconf"
    "openssl"
    "unzip"
)

depends:yum=(
    "java-11-openjdk-headless"
    "cryptopp"
    "openssl"
    "pcsc-lite"
)
makedepends:yum=(
    "cryptopp-devel"
    "gcc-c++"
    "java-11-openjdk-devel"
    "meson"
    "openssl-devel"
    "pcsc-lite-devel"
    "pkgconf-pkg-config"
)

depends:zypper=(
    "java-11-openjdk-headless"
    "libcryptopp8_2_0"
    "libopenssl"
    "pcsc-lite"
)
makedepends:zypper=(
    "libcryptopp-devel" 
    "gcc-c++"
    "java-11-openjdk-devel"
    "libopenssl-devel"
    "meson"
    "pcsc-lite-devel"
    "pkgconf-pkg"
)

build:archlinux() {
    export JAVA_HOME=/usr/lib/jvm/default/
    cd "${srcdir}/${pkgname}-linux-main"
    gradle -b cie-java/build.gradle standalone
    cd libcie-pkcs11
    meson builddir
    meson configure -Dprefix=/usr builddir
    meson compile -C builddir
}

build:fedora() {
    export JAVA_HOME=/usr/lib/jvm/java-11-openjdk/
    cd "${srcdir}/${pkgname}-linux-main"
    ../gradle-7.3/bin/gradle -b cie-java/build.gradle standalone
    cd libcie-pkcs11
    meson builddir
    meson configure -Dprefix=/usr builddir
    meson compile -C builddir
}

build:opensuse() {
    export JAVA_HOME=/usr/lib64/jvm/java-11-openjdk/
    cd "${srcdir}/${pkgname}-linux-main"
    ../gradle-7.3/bin/gradle -b cie-java/build.gradle standalone
    cd libcie-pkcs11
    meson builddir
    meson configure -Dprefix=/usr builddir
    meson compile -C builddir
}

build:ubuntu() {
    export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    pip3 install ninja meson
    cd "${srcdir}/${pkgname}-linux-main"
    ../gradle-7.3/bin/gradle -b cie-java/build.gradle standalone
    cd libcie-pkcs11
    meson builddir
    meson configure -Dprefix=/usr builddir
    meson compile -C builddir
}

package() {
    cd "${srcdir}/${pkgname}-linux-main"
    
    # Java Application
    install -Dm755 cie-java/bin/libs/CIEID-standalone.jar \
    "${pkgdir}/usr/share/cieid/cieid.jar"
    install -Dm644 "data/cieid.desktop" \
    "${pkgdir}/usr/share/applications/cieid.desktop"
    install -Dm755 data/logo.png \
    "${pkgdir}/usr/share/pixmaps/cieid.png"    
    install -Dm755 "data/cieid.sh" \
    "${pkgdir}/usr/bin/cieid"
    install -Dm644 LICENSE \
    "${pkgdir}/usr/share/licenses/cieid/LICENSE"

    # Lib
    cd libcie-pkcs11
    DESTDIR="${pkgdir}" meson install -C builddir 
}
